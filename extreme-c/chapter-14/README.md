#### Синхронизация

Состояние гонки - неотъемлемое св-во конкурентной системы.

Существуют два вида гонок:

- гонка данных;
- гонка состояния.

##### Гонка данных

В такой системе имеется от двух и более заданий и разделяемый ресурс.
Под ресурсом может пониматься как переменная (участок памати) так и переферия 
(например: порт ввода/вывода).
Доступ к разделяемому ресурсу имеют все задания в системе, таким образом
все они могут изменять состояние разделяемого ресурса.

**Примечание:**
В случае доступа (чтения) к разделяемому ресурсу со стороны нескольких заданий
состояние гонки не возникает, т.к. задания не меняют состояние разделяемого ресурса.

##### Гонка состояния

Конкурентная система может и не иметь разделяемого ресурса, но при этом 
выполнение задач должно осуществляться в определенной последовательности.

В случае гонки (состояние / данных) необходимо применять механизмы синхронизации.

##### Постсинхронизационные проблемы

- Новые естественные проблемы;
- Недоступность ресурсов. Эта ситуация возникает, когда задание в конкурентной
системе не может обратиться к разделяемому ресурсу на протяжении длительного
времени;
- Взаимные блокировки. Когда все задания в конкурентной системе ждут друг 
друга и ни одно из них не продвигается вперед;
- Перестановка приоритетов.

##### Методы синхронизации

**Примечание:**
Предположим что в системе есть 2 задания: А и Б.

- Холостой цикл - задание Б постоянно ждет когда задание А завершит свои действия.
При этом процесссорное время тратится впустую, т.к. задание Б ничего не делает, кроме 
опроса флага.

- Ожидание / уведомление - задание Б может не ждать флаг, а "уснуть" и таким образом
планировщик передаст управление заданию А, которое в свою очередь выполнив свои
действия уведомит об этом задание Б.

**Примечание:**
При этом может возникнуть такая ситуация, при которой задание А отправит уведомление 
заданию Б до того как Б перейдет в сон. Это приведет к тому что задание Б перейдет
в сон, но никогда из него не выйдет.

##### Семафоры и мьютексы

Семафоры — обычные переменные или объекты, которые используются для синхронизации доступа 
к разделяемому ресурсу.

Критический участок — всего лишь набор инструкций, защищенных семафором. Задание не может 
в него войти без разрешения от семафора.

Семафор, который разрешает входить на критический участок по одному, обычно называют
двоичным семафором или **мьютексом**.

##### Системы с несколькими вычислительными блоками

Чтобы решить проблему, которая возникает из-за наличия разных локальных кэшей в каждом ядре 
процессора, используется протокол *когерентности памяти*.

Барьеры памяти - применяются в случае когда два задания выполняются на разных вычислительных
блоках (разных ядрах).
Барьеры памяти синхронизируют локальные кэши всех ядер процессора и основную память.

##### Циклические блокировки (spinlock)

Циклические блокировки очень распространены в высокопроизводительных системах, в которых 
переход задания в спящий режим занимает намного больше времени по сравнению с частотой событий, 
возникающих в системе.
При использовании циклических блокировок задания должны быть написаны так, чтобы могли 
разблокировать мьютекс как можно раньше. Для этого критический участок должен быть достаточно компактным. 

В случае с мьютексом, при попытке захвата недоступного мьютекса, процесс переходит в режим sleep.
В случае с циклической блокировкой, при попытке захвата недоступного spinlock процесс не блокируется,
а продолжает циклически читать состояние.


##### Потоки

Все потоки внутри одного процесса имеют доступ к общей памяти и могут использовать ее для 
хранения разделяемого состояния. Поток принадлежит процессу, он не может существовать отдельно.

![thread](https://github.com/GIYura/c-tutorial/blob/main/extreme-c/chapter-14/thread.png)

##### Процессы

В каждом процессе память изолирована, необходимо специальные маханизмы ее синхронизации.
Процесс можно рассматривать как некий контейнер для запуска и выполнения программ.
Каждый процесс имеет как минимум один поток выполнения.

![process](https://github.com/GIYura/c-tutorial/blob/main/extreme-c/chapter-14/process.png)

